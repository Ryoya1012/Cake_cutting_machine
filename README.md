# Cake_cutting_machine

## The purpose
 The robot recognizes the cake and performs actions such as cutting and rotating the cake.

## Specification
 - Vision-related
    - Cake_cutting_opencv : Python opencv

 - ESP32-related
    - Moving_motorv : Arduino IDE(using MPU : ESP32)


## Program
  esp32_communication.py  
   このコードは, ウェブカメラでケーキの回転システムを制御するプログラムになっています.  
   ケーキを指定した分割数に基づき等分線を計算し, 各等分線にナイフの刃先が来るようにESP32とシリアル通信を用いてその回転を制御する.  

  ### プログラムの処理の流れ
    1. ESP32への接続試行
    - 目的:ESP32(外部デバイス)との通信を確立します.
    - 処理:  
     1. ```initialize_esp32```関数が呼び出され, 指定ポート(COM3)で接続を試みます.
     2. 成功した場合:
        - ESP32が接続され,「ESP32に接続しました」と表示される.
     3. 失敗した場合:
        - エラーが表示され, プログラムが終了する(```exit()```).
    
    2. ユーザーからの入力
    - 目的:ユーザーがケーキを何等分するかを指定する.
    - 処理:  
        - プロンプト```ケーキを何等分にしますか?:```を表示.
        - ユーザーが入力した数値を整数(```int型```)として受け取り, 分割数(```num_divisions```)に保存.

    3. カメラの起動
    - 目的:ウェブカメラを起動して画像フレームを取得.
    - 処理:
      1. OpenCVの```cv2.VideoCapture(1)```を使用してカメラを起動.
       - 引数は```1```はカメラデバイス番号を指定.
      2. カメラが見つからなかった場合:
        - エラーメッセージ「ウェブカメラが見つかりません」を表示し, プログラムを終了

    4. フレームの取得と円の検出
    - 目的:画像フレームからケーキを検出(中心と半径を特定).
    - 処理:  
      1. OPenCVの```cv2.VideoCapture(1)```を使用してカメラを起動.
       - 引数```1```はカメラデバイス番号を指定する.
      2. カメラが見つからなかった場合:
        - エラーメッセージ「ウェブカメラが見つかりません」を表示し, プログラムを終了します.
      3. OpenCVのHough変換(```cv2.HoughCircles```)を使って円を検出. 
        - パラメータを基に円の中心(中心座標)と半径を取得する.

    5. 分割数の描画
    - 目的:検出した円に基づいて指定された分割数で分割線を描画.
    - 処理:
      1. 円を分割するための1津当たりの角度(360°/分割数)を計算.
      2. 中心から半径の長さを持つ分割線を順次描画.
      3. 描画はOpenCVの```cv2.line```を使用.
    
    6. 現在の回転角度の計算
    - 目的:回転の基準となる角度を計算, 累積角度を更新.
    - 処理:
      1. 円の中心と参照点(円の外側の1点)からベクトルを作成.
      2. ```math.atan2```を使用して, このベクトルの角度計算.
      3. 前回の角度との差分を求め, ±180°を超えた場合は補正して累積角度に加算.

    7. ケーキの回転処理
    - 目的:指定された分割線の位置にケーキを回転させる.
    - 処理:
      1. 現在の分割番号(```current_division```)に基づいて目標角度(```target_angle```)を計算.
      2. ESP32に目標角度を送信(```send_command_to_esp32("TARGET", target_angle)```).
      3. ESP32からの応答を待機.
       - 応答が「READY」の場合, 次の処理に進む.
       - 応答がない場合, 現在の角度を計算し, 目標角度との差を補正するために再度コマンドを送信.
      4. 回転が完了したら, 「COMPLETE」コマンドをESP32に送信.

    8. フレームの表示
    - 目的:現在の処理状況をユーザーに表示します.
    - 処理:
      - OpenCVのウィンドウにフレームを表示(cv2.imshow).
      - 円, 分割線, 中心点等が描画された映像をリアルタイムで確認可能.
    
    9. 終了条件の確認
    - 目的:処理を終了するタイミングを確認する.
    - 処理:
     - カメラを解放(```cap.release()```).
     - OpenCVのすべてのウィンドウを閉じる(```cv2.destroyAllWindows()```).